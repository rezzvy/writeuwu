class WriteUWU{constructor(t={}){if(!t.target||!(t.target instanceof HTMLElement))throw TypeError("[WriteUWU] Initialization failed. A valid DOM element is required for 'target'.");if(this.target=t.target,void 0!==t.speed&&("number"!=typeof t.speed||t.speed<0))throw TypeError("[WriteUWU] Invalid 'speed' value. It must be a positive number.");this.speed=t.speed||25,["onStart","onTyping","onFinish"].forEach(e=>{if(void 0!==t[e]&&"function"!=typeof t[e])throw TypeError(`[WriteUWU] Invalid callback for '${e}'. It must be a function.`)}),this.onStart=t.onStart,this.onTyping=t.onTyping,this.onFinish=t.onFinish,this._context={vars:{},funcs:{},aliases:{}},this._sys={tokenIndex:0,tokens:[],status:"idle",timeout:null,delayTimeout:null,delayResolve:null,maxExecutions:1e3,executions:0},this._api={},Object.defineProperties(this._api,{tokens:{get:()=>this._sys.tokens},tokenIndex:{get:()=>this._sys.tokenIndex},progress:{get:()=>{let{tokenIndex:t,tokens:e}=this._sys,i=e.length?t/e.length:0;return{raw:i,percent:`${Math.round(100*i)}%`}}}})}get api(){return this._api}isOnlyDirectives(t){if("string"!=typeof t||!t.trim())return!1;let e=this._parseText(t);return 0!==e.length&&e.every(t=>t.startsWith("[@"))}write(t){if("string"!=typeof t)throw TypeError("[WriteUWU] Invalid argument for 'write'. Expected a string.");this._clear(),this._sys.tokens=this._parseText(t),this._sys.status="typing",this._runEvent("onStart"),this._tick()}pause(){"typing"===this._sys.status&&(clearTimeout(this._sys.timeout),this._sys.status="paused",this._sys.timeout=null)}resume(){"paused"===this._sys.status&&(this._sys.status="typing",this._tick())}skip(){if("typing"!==this._sys.status||!document.body.contains(this.target))return;this._clearTimers(),this._sys.status="skipping";let t=async()=>{let t="";for(;this._sys.tokenIndex<this._sys.tokens.length;){if(++this._sys.executions>this._sys.maxExecutions){console.error("[WriteUWU] Skip aborted due to a potential infinite loop.");break}let e=this._sys.tokens[this._sys.tokenIndex];if(e.startsWith("[@")){let i=this._parseDirective(e),s="async"===i.type||"delay"===i.type;if(this._context.aliases[i.type]){let n=this._context.aliases[i.type].type;"async"===n&&(s=!0)}if(s){this._sys.tokenIndex+=1;continue}await this._runDirective(i),this._sys.tokenIndex+=1;continue}t+=e,this._sys.tokenIndex+=1,this._sys.executions=0}this.target.innerHTML+=t,this._tickFinishHandler()};t()}setVar(t,e){if("string"!=typeof t||!t.trim())throw TypeError("[WriteUWU] Invalid variable name. 'setVar' requires a non-empty string key.");this._context.vars[t]=e}setFn(t,e){if("string"!=typeof t||!t.trim())throw TypeError("[WriteUWU] Invalid function name. 'setFn' requires a non-empty string key.");if("function"!=typeof e)throw TypeError(`[WriteUWU] Invalid function provided for key '${t}'. It must be a function.`);this._context.funcs[t]=e}setFnAlias(t,e,i="run"){if("string"!=typeof t||!t.trim())throw TypeError("[WriteUWU] Invalid alias name. 'setFnAlias' requires a non-empty string key.");if(["speed","delay","var","run","async","eval",].includes(t))throw Error(`[WriteUWU] Alias '${t}' conflicts with a built-in directive. Please choose another name.`);if("string"!=typeof e||!e.trim())throw TypeError("[WriteUWU] Invalid function name. 'setFnAlias' requires a non-empty string 'functionName'.");let s=["run","async","eval"].includes(i)?i:"run";this._context.aliases[t]={fnName:e,type:s}}async _tick(){if("typing"===this._sys.status){if(!document.body.contains(this.target)){console.warn("[WriteUWU] Target element is no longer in the DOM. Execution aborted."),this._sys.status="idle",this._clear();return}if(++this._sys.executions>this._sys.maxExecutions){console.error("[WriteUWU] Execution stopped due to a potential infinite loop in '_tick()'.");return}if(this._sys.tokenIndex>=this._sys.tokens.length){this._tickFinishHandler();return}if(this._sys.tokens[this._sys.tokenIndex].startsWith("[@")){await this._tickDirectiveContentHandler();return}this._tickTypingHandler(),this._sys.timeout=setTimeout(()=>{this._tick()},this.speed)}}async _tickDirectiveContentHandler(){let t=this._parseDirective(this._sys.tokens[this._sys.tokenIndex]);await this._runDirective(t),this._sys.tokenIndex+=1,this._tick()}_tickTypingHandler(){this.target.innerHTML+=this._sys.tokens[this._sys.tokenIndex],this._sys.tokenIndex+=1,this._sys.executions=0,this._runEvent("onTyping")}_tickFinishHandler(){this._sys.status="idle",this._runEvent("onFinish"),this._clear()}async _runDirective({type:t,value:e}){if("typing"===this._sys.status||"skipping"===this._sys.status){if(this._context.aliases[t]){let i=this._context.aliases[t];t=i.type,e=e?`${i.fnName}(${e})`:`${i.fnName}()`}if(!["speed","delay","var","run","async","eval"].includes(t)){console.warn(`[WriteUWU] Unknown directive '${t}'. It will be ignored.`);return}if("speed"===t){if(!e)return;let s=Number(e);if(isNaN(s)||s<0){console.warn(`[WriteUWU] Invalid speed value '${e}'. Directive ignored.`);return}this.speed=s;return}if("delay"===t){if(!e)return;let n=Number(e);if(isNaN(n)||n<0){console.warn(`[WriteUWU] Invalid delay value '${e}'. Directive ignored.`);return}await new Promise(t=>{this._sys.delayResolve=t,this._sys.delayTimeout=setTimeout(()=>{this._sys.delayResolve=null,t()},n)});return}if("var"===t){if(!e)return;if(!(e in this._context.vars)){console.warn(`[WriteUWU] Variable '${e}' is not defined.`);return}let r=this._unwrapDirective(this._context.vars[e]);this._injectNewToken(r);return}if("run"===t||"async"===t||"eval"===t){if(!e)return;let{fn:a,param:o,name:l}=this._unwrapFn(e);if("function"!=typeof a){console.warn(`[WriteUWU] Function '${l||e}' is not defined or not callable.`);return}try{if("run"===t||"async"===t)"run"===t?a(o):await a(o);else{let h=this._unwrapDirective(a(o));this._injectNewToken(h)}}catch(u){console.error(`[WriteUWU] Failed to execute function '${l||e}'.`,u)}}}}_clearTimers(){clearTimeout(this._sys.timeout),clearTimeout(this._sys.delayTimeout),this._sys.delayResolve&&(this._sys.delayResolve(),this._sys.delayResolve=null),this._sys.timeout=null,this._sys.delayTimeout=null}_clear(){this._clearTimers(),this._sys.tokenIndex=0,this._sys.executions=0,this._sys.tokens=[]}_injectNewToken(t){if(null==t)return;let e=this._parseText(String(t));this._sys.tokens.splice(this._sys.tokenIndex+1,0,...e)}_runEvent(t){let e=this[t];if("function"==typeof e)try{e(this.api)}catch(i){console.error(`[WriteUWU] Error occurred in event '${t}'.`,i)}}_unwrapDirective(t){return"string"!=typeof t?String(t||""):t.replace(/\[@([^\]]+)\]/g,"$1")}_unwrapFn(t){if(!t)return{fn:null,name:null,param:null};let e=t.match(/^(\w+)\((.*)\)$/);if(!e){let i=this._context.funcs[t]??null;return{fn:i,name:t,param:null}}let[,s,n]=e,r=this._context.funcs[s],a=n?.length?n.replace(/^["']|["']$/g,""):null;return{fn:r,name:s,param:a}}_parseText(t){if("string"!=typeof t)return[];let e=(t.match(/\[@/g)||[]).length,i=(t.match(/\[@[^\]]+\]/g)||[]).length;if(e>i){let s=t.split("[@");for(let n=1;n<s.length;n++)if(!s[n].includes("]")){let r=s[n].substring(0,30),a=s[n].length>30?"...":"";console.warn(`[WriteUWU] Detected an unclosed directive near "[@${r}${a}".`)}}let o=t.match(/\[@[^\]]+\]|<[^>]+>|&[^;]+;|[\uD800-\uDBFF][\uDC00-\uDFFF]|./g);return o||[]}_parseDirective(t){if(!t||"string"!=typeof t)return{type:"",value:""};let e=t.slice(2,-1),i=e.indexOf(":");return -1===i?{type:e.trim(),value:""}:{type:e.slice(0,i).trim(),value:e.slice(i+1).trim()}}}